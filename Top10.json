{
  "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
  "width": 900,
  "height": 700,
  "autosize": {
    "type": "fit",
    "contains": "padding"
  },
  "title": {
    "text": "Australian Domestic Flight Network",
    "fontSize": 22,
    "fontWeight": "bold",
    "subtitle": "December passenger data (1984-2019) | Source: data.gov.au",
    "subtitleFontSize": 12,
    "subtitleColor": "#7f8c8d"
  },
  
  "params": [
    {
      "name": "year_select",
      "value": 2019,
      "bind": {
        "input": "range",
        "min": 1984,
        "max": 2019,
        "step": 1,
        "name": "ğŸ“… Year: "
      }
    }
  ],
  
  "layer": [
    {
      "data": {
        "url": "https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json",
        "format": {"type": "topojson", "feature": "countries"}
      },
      "transform": [
        {"filter": "datum.properties.name == 'Australia'"}
      ],
      "mark": {
        "type": "geoshape",
        "fill": "#e8f4f8",
        "stroke": "#34495e",
        "strokeWidth": 1.5
      },
      "projection": {
        "type": "mercator",
        "center": [133, -28],
        "scale": 800,
        "clipExtent": [[0, 0], [900, 700]]
      }
    },
    
    {
      "data": {"url": "../data/audomcitypairs-201912.csv"},
      "transform": [
        {"filter": "datum.Year == year_select"},
        {"filter": "datum.Month_num == 12"},
        {"filter": "datum.Passenger_Trips > 10000"},
        
        {
          "lookup": "City1",
          "from": {
            "data": {"url": "../data/cities.json"},
            "key": "city",
            "fields": ["lat", "lon"]
          },
          "as": ["lat1", "lon1"]
        },
        {
          "lookup": "City2",
          "from": {
            "data": {"url": "../data/cities.json"},
            "key": "city",
            "fields": ["lat", "lon"]
          },
          "as": ["lat2", "lon2"]
        },
        
        {"filter": "datum.lat1 >= -45 && datum.lat1 <= -10"},
        {"filter": "datum.lon1 >= 112 && datum.lon1 <= 155"},
        {"filter": "datum.lat2 >= -45 && datum.lat2 <= -10"},
        {"filter": "datum.lon2 >= 112 && datum.lon2 <= 155"},
        
        {
          "window": [{"op": "rank", "as": "rank"}],
          "sort": [{"field": "Passenger_Trips", "order": "descending"}]
        }
      ],
      
      "params": [
        {
          "name": "hover",
          "select": {
            "type": "point",
            "on": "mouseover",
            "clear": "mouseout"
          }
        }
      ],
      
      "mark": {
        "type": "rule",
        "strokeCap": "round",
        "clip": true,
        "cursor": "pointer"
      },
      
      "encoding": {
        "longitude": {"field": "lon1", "type": "quantitative"},
        "latitude": {"field": "lat1", "type": "quantitative"},
        "longitude2": {"field": "lon2"},
        "latitude2": {"field": "lat2"},
        
        "strokeWidth": {
          "condition": [
            {
              "param": "hover",
              "empty": false,
              "value": 18
            },
            {
              "test": "datum.rank <= 3",
              "value": 12
            }
          ],
          "field": "Passenger_Trips",
          "type": "quantitative",
          "scale": {
            "type": "sqrt",
            "range": [0.5, 10]
          },
          "legend": {
            "title": "Passengers",
            "orient": "top-left",
            "direction": "horizontal",
            "format": ".2s",
            "titleFontSize": 11,
            "labelFontSize": 10,
            "symbolType": "stroke",
            "symbolStrokeWidth": 2,
            "symbolSize": 100,
            "offset": 5,
            "padding": 5
          }
        },
        
        "opacity": {
          "condition": {
            "param": "hover",
            "empty": false,
            "value": 1
          },
          "value": 0.7
        },
        
        "color": {
          "field": "Passenger_Load_Factor",
          "type": "quantitative",
          "scale": {
            "scheme": "viridis",
            "domain": [50, 100]
          },
          "legend": {
            "title": "Load Factor (%)",
            "orient": "top-right",
            "direction": "horizontal",
            "format": ".0f",
            "titleFontSize": 11,
            "labelFontSize": 10,
            "offset": 5,
            "padding": 5
          }
        },
        
        "tooltip": [
          {"field": "City1", "title": "From"},
          {"field": "City2", "title": "To"},
          {"field": "Year", "title": "Year"},
          {"field": "rank", "title": "Rank"},
          {"field": "Passenger_Trips", "title": "Passengers", "format": ","},
          {"field": "Passenger_Load_Factor", "title": "Load Factor", "format": ".1f"},
          {"field": "Distance_GC_(km)", "title": "Distance (km)", "format": ","}
        ]
      },
      
      "projection": {
        "type": "mercator",
        "center": [133, -28],
        "scale": 800,
        "clipExtent": [[0, 0], [900, 700]]
      }
    },
    
    {
      "data": {"url": "../data/audomcitypairs-201912.csv"},
      "transform": [
        {"filter": "datum.Year == year_select"},
        {"filter": "datum.Month_num == 12"},
        
        {
          "lookup": "City1",
          "from": {
            "data": {"url": "../data/cities.json"},
            "key": "city",
            "fields": ["lat", "lon"]
          },
          "as": ["lat1", "lon1"]
        },
        {
          "lookup": "City2",
          "from": {
            "data": {"url": "../data/cities.json"},
            "key": "city",
            "fields": ["lat", "lon"]
          },
          "as": ["lat2", "lon2"]
        },
        
        {
          "window": [{"op": "rank", "as": "rank"}],
          "sort": [{"field": "Passenger_Trips", "order": "descending"}]
        },
        
        {"filter": "datum.rank <= 10"},
        
        {
          "calculate": "(datum.lat1 + datum.lat2) / 2",
          "as": "mid_lat"
        },
        {
          "calculate": "(datum.lon1 + datum.lon2) / 2",
          "as": "mid_lon"
        },
        {
          "calculate": "datum.rank",
          "as": "rank_text"
        }
      ],
      
      "mark": {
        "type": "text",
        "fontSize": 14,
        "fontWeight": "bold",
        "color": "#ffffff",
        "stroke": "#2c3e50",
        "strokeWidth": 3,
        "filled": true
      },
      
      "encoding": {
        "longitude": {"field": "mid_lon", "type": "quantitative"},
        "latitude": {"field": "mid_lat", "type": "quantitative"},
        "text": {"field": "rank_text", "type": "ordinal"}
      },
      
      "projection": {
        "type": "mercator",
        "center": [133, -28],
        "scale": 800
      }
    },
    
    {
      "data": {"url": "../data/cities.json"},
      "transform": [
        {
          "calculate": "datum.city == 'SYDNEY' || datum.city == 'MELBOURNE' || datum.city == 'BRISBANE' ? 300 : 200",
          "as": "point_size"
        }
      ],
      "mark": {
        "type": "circle",
        "fill": "#e74c3c",
        "stroke": "white",
        "strokeWidth": 2.5,
        "opacity": 0.95
      },
      "encoding": {
        "longitude": {"field": "lon", "type": "quantitative"},
        "latitude": {"field": "lat", "type": "quantitative"},
        "size": {
          "field": "point_size",
          "type": "quantitative",
          "legend": null
        },
        "tooltip": {"field": "city", "title": "Airport"}
      },
      "projection": {
        "type": "mercator",
        "center": [133, -28],
        "scale": 800
      }
    },
    
    {
      "data": {"url": "../data/cities.json"},
      "transform": [
        {
          "calculate": "upper(substring(datum.city, 0, 1)) + lower(substring(datum.city, 1))",
          "as": "city_formatted"
        }
      ],
      "mark": {
        "type": "text",
        "dy": -15,
        "fontSize": 12,
        "fontWeight": "bold",
        "color": "#2c3e50"
      },
      "encoding": {
        "longitude": {"field": "lon", "type": "quantitative"},
        "latitude": {"field": "lat", "type": "quantitative"},
        "text": {"field": "city_formatted"}
      },
      "projection": {
        "type": "mercator",
        "center": [133, -28],
        "scale": 800
      }
    },
    
    {
      "data": {
        "values": [{"x": 850, "y": 650}]
      },
      "mark": {
        "type": "text",
        "align": "right",
        "baseline": "bottom",
        "fontSize": 80,
        "fontWeight": 100,
        "color": "#ecf0f1",
        "opacity": 0.3
      },
      "encoding": {
        "x": {"field": "x", "type": "quantitative", "scale": null},
        "y": {"field": "y", "type": "quantitative", "scale": null},
        "text": {"signal": "year_select"}
      }
    },
    
    {
      "data": {
        "values": [
          {"text": "ğŸ’¡ Numbers on routes show Top 10 ranking", "x": 450, "y": 35}
        ]
      },
      "mark": {
        "type": "text",
        "align": "center",
        "fontSize": 13,
        "color": "#34495e",
        "fontStyle": "italic"
      },
      "encoding": {
        "x": {"field": "x", "type": "quantitative", "scale": null},
        "y": {"field": "y", "type": "quantitative", "scale": null},
        "text": {"field": "text"}
      }
    }
  ],
  
  "config": {
    "view": {"stroke": null},
    "background": "white"
  }
}